<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Design System Portal</title>

<style>
body {
  font-family: system-ui;
  padding: 40px;
  background: #f5f6f8;
}

h1 { margin-bottom: 24px; }

.controls {
  display: flex;
  gap: 16px;
  margin-bottom: 32px;
  align-items: center;
}

select, input {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.token {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid #e5e7eb;
}

.meta {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
}

.alias {
  font-family: monospace;
  font-size: 12px;
  color: #888;
  margin-top: 6px;
}

.swatch {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  margin-bottom: 8px;
  border:1px solid #ddd;
}
</style>
</head>

<body>

<h1>Design System Portal</h1>

<div class="controls">

<select id="platform">
  <option value="base">Base</option>
  <option value="web">Web</option>
</select>

<select id="tier" multiple size="4">
  <option value="all" selected>All tiers</option>
  <option value="core">Core</option>
  <option value="semantic">Semantic</option>
  <option value="component">Component</option>
</select>

<input id="search" placeholder="Search..." />

</div>

<div id="tokens"></div>

<script>
fetch('./tokens.json')
.then(res => res.json())
.then(data => {

const container = document.getElementById('tokens');
const platformSelect = document.getElementById('platform');
const tierSelect = document.getElementById('tier');
const searchInput = document.getElementById('search');

function flatten(obj, path=[], platform=null, tier=null) {
  let result = {};

  Object.entries(obj).forEach(([key, value]) => {

    if (key === 'base' || key === 'web') {
      Object.assign(result, flatten(value, path, key, tier));
    }
    else if (key.includes('core')) {
      Object.assign(result, flatten(value, path, platform, 'core'));
    }
    else if (key.includes('semantic')) {
      Object.assign(result, flatten(value, path, platform, 'semantic'));
    }
    else if (key.includes('component')) {
      Object.assign(result, flatten(value, path, platform, 'component'));
    }
    else if (value.$value !== undefined) {
      result[path.concat(key).join('.')] = {
        ...value,
        platform,
        tier
      };
    }
    else if (typeof value === 'object') {
      Object.assign(result, flatten(value, path.concat(key), platform, tier));
    }

  });

  return result;
}

const flat = flatten(data);

function resolveAlias(value, chain=[]) {
  if (!value || !value.startsWith('{')) return chain;

  const clean = value.replace(/[{}]/g,'');
  chain.push(clean);

  const next = flat[clean];
  if (next) return resolveAlias(next.$value, chain);

  return chain;
}

function getSelectedTiers() {
  const selected = Array.from(tierSelect.selectedOptions).map(o => o.value);

  if (selected.includes('all')) {
    return ['core','semantic','component'];
  }

  return selected;
}

function render() {
  container.innerHTML='';

  const platform = platformSelect.value;
  const tiers = getSelectedTiers();
  const search = searchInput.value.toLowerCase();

  Object.entries(flat).forEach(([name, token]) => {

    if (token.platform !== platform) return;
    if (!tiers.includes(token.tier)) return;
    if (!name.toLowerCase().includes(search)) return;

    const aliasChain = resolveAlias(token.$value, []);
    let finalValue = token.$value;

    if (aliasChain.length) {
      const last = flat[aliasChain[aliasChain.length -1]];
      if (last) finalValue = last.$value;
    }

    const div = document.createElement('div');
    div.className='token';

    const isColor = /^#/.test(finalValue);

    div.innerHTML=`
      <div><strong>${name}</strong></div>
      <div class="meta">${token.platform} → ${token.tier}</div>
      ${isColor ? `<div class="swatch" style="background:${finalValue}"></div>`:''}
      <div>Value: ${finalValue}</div>
      ${aliasChain.length ? `<div class="alias">Alias chain → ${aliasChain.join(' → ')}</div>`:''}
    `;

    container.appendChild(div);
  });
}

platformSelect.addEventListener('change', render);
tierSelect.addEventListener('change', render);
searchInput.addEventListener('input', render);

render();

});
</script>

</body>
</html>
